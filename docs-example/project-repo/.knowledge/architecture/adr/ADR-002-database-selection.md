# ADR-002: 选择 PostgreSQL 作为主数据库

- **状态**: 已接受
- **日期**: 2025-11-30
- **决策者**: @技术负责人, @DBA团队

---

## Context (背景)

我们需要为电商平台选择主数据库，需要满足以下需求：

1. **数据一致性**: 订单、支付等场景需要强一致性保证
2. **查询复杂度**: 需要支持复杂的联表查询和聚合
3. **数据量**: 预计单表数据量可达亿级
4. **扩展性**: 需要支持读写分离和分库分表
5. **成本**: 开源优先，避免高额许可费

候选方案：
- PostgreSQL
- MySQL
- MongoDB

---

## Decision (决策)

**我们决定选择 PostgreSQL 15 作为主数据库。**

### 主要理由

| 维度 | PostgreSQL | MySQL | MongoDB |
|------|------------|-------|---------|
| **ACID支持** | ✅ 完整 | ✅ 完整 | ⚠️ 部分 |
| **JSON支持** | ✅ 优秀(JSONB) | ⚠️ 一般 | ✅ 原生 |
| **复杂查询** | ✅ 强大 | ⚠️ 一般 | ❌ 受限 |
| **扩展性** | ✅ 插件丰富 | ✅ 成熟 | ✅ 原生分片 |
| **许可证** | ✅ 开源(PostgreSQL) | ⚠️ 开源(GPL) | ⚠️ SSPL |

### 版本选择

选择 **PostgreSQL 15**，因为：
- 性能改进：排序和窗口函数性能提升
- JSON改进：更好的JSON路径查询支持
- 安全增强：更好的权限管理
- 长期支持

---

## Consequences (后果)

### 正面影响 ✅

1. **数据完整性**: ACID事务保证订单数据一致性
2. **灵活查询**: 支持复杂的业务报表查询
3. **JSON能力**: JSONB支持半结构化数据存储
4. **成本控制**: 开源无许可费用
5. **生态成熟**: 丰富的工具和云服务支持

### 负面影响 ⚠️

1. **学习曲线**: 团队MySQL经验为主，需要学习
2. **水平扩展**: 原生分库分表支持不如MongoDB
3. **运维差异**: 与MySQL运维方式有所不同

### 配套决策

| 场景 | 方案 |
|------|------|
| 读写分离 | 主从复制 + 读写路由 |
| 连接池 | PgBouncer |
| 分库分表 | Citus扩展 (如需要) |
| 备份 | pg_dump + WAL归档 |

---

## Alternatives Considered (备选方案)

### MySQL 8.0

**优点**: 团队经验丰富、运维成熟
**缺点**: JSON支持较弱、扩展能力有限
**放弃原因**: 商品属性需要灵活的JSON存储

### MongoDB 6.0

**优点**: 原生分片、JSON存储
**缺点**: 事务支持较晚、复杂查询受限
**放弃原因**: 订单场景需要强事务支持

---

## References (参考)

- [PostgreSQL vs MySQL 对比](https://www.postgresql.org/about/)
- [技术雷达 - PostgreSQL](../../../enterprise-standards/technology-radar/adopt.md)

---

## 变更历史

| 日期 | 变更 | 作者 |
|------|------|------|
| 2025-11-30 | 初始决策 | @技术负责人 |
