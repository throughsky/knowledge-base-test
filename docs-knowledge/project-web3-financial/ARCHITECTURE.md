# 架构知识入口

## 系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API Gateway                                     │
│                         (认证/限流/路由/审计)                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
     ┌──────────────┬───────────────┼───────────────┬──────────────┐
     │              │               │               │              │
     ▼              ▼               ▼               ▼              ▼
┌─────────┐  ┌─────────┐  ┌─────────────┐  ┌─────────┐  ┌─────────┐
│  User   │  │ Bridge  │  │ Stablecoin  │  │   RWA   │  │Tokenize │
│ Service │  │ Service │  │   Service   │  │ Service │  │ Service │
│(身份认证)│  │(法币桥接)│  │ (稳定币)    │  │(资产代币)│  │(存款代币)│
└─────────┘  └────┬────┘  └──────┬──────┘  └────┬────┘  └────┬────┘
                  │              │              │            │
     ┌────────────┴──────────────┼──────────────┴────────────┘
     │                           │
     │    ┌─────────┐  ┌─────────┴─────────┐  ┌─────────┐
     │    │ Lending │  │                   │  │ Staking │
     │    │ Service │◀─│                   │─▶│ Service │
     │    │ (借贷)  │  │                   │  │ (质押)  │
     │    └────┬────┘  │                   │  └────┬────┘
     │         │       │                   │       │
     └─────────┴───────┴─────────┬─────────┴───────┘
                                 │
                    ┌────────────▼────────────┐
                    │      Custody Service    │
                    │    (托管钱包/密钥管理)    │
                    │   HSM | MPC | 多签管理   │
                    └────────────┬────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │   Compliance Service    │
                    │     (AML/KYC/风控)       │
                    │   ⚠️ 可冻结任何账户      │
                    └────────────┬────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │     Blockchain Layer    │
                    │   Ethereum | Polygon    │
                    └─────────────────────────┘
```

## 服务全景

| 服务 | 职责 | 核心能力 |
|------|------|----------|
| **user-service** | 身份与认证 | 注册/登录、RBAC、JWT、MFA |
| **bridge-service** | 法币桥接 | 出入金、银行对接、汇率报价 |
| **stablecoin-service** | 稳定币管理 | 铸造/赎回、储备管理 |
| **rwa-service** | 资产代币化 | RWA上链、发行、分红 |
| **tokenization-service** | 存款代币化 | 银行存款→链上代币 |
| **lending-service** | 借贷协议 | 抵押借款、利率、清算 |
| **staking-service** | 质押服务 | 质押、LST、奖励分发 |
| **custody-service** | 资产托管 | 密钥管理、多签、交易签名 |
| **compliance-service** | 合规风控 | KYC/AML、交易监控、SAR |

## 核心依赖关系

```
                      ┌─────────────┐
                      │    User     │ ─────────────────────────────┐
                      │   Service   │  所有服务依赖(身份验证)       │
                      └─────────────┘                              │
                                                                   ▼
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  ┌──────────┐
│  Bridge  │───▶│Stablecoin│◀───│   RWA    │    │Tokenize  │  │ Lending  │
│ Service  │    │ Service  │    │ Service  │    │ Service  │  │ Service  │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘  └────┬─────┘
     │               │               │               │             │
     │               │               │               │             │
     └───────────────┴───────────────┴───────────────┴─────────────┘
                                     │
                            ┌────────▼────────┐
                            │    Custody      │ ◀── 核心供应商
                            │    Service      │     (资产托管)
                            └────────┬────────┘
                                     │
                            ┌────────▼────────┐
                            │   Compliance    │ ◀── 最高权限
                            │    Service      │     (可冻结账户)
                            └─────────────────┘
```

## 服务目录

→ 详见 [architecture/service-catalog.md](./architecture/service-catalog.md)

## 数据流

→ 详见 [architecture/data-flow.md](./architecture/data-flow.md)

## 通信模式

### 同步通信 (gRPC/REST)

| 调用方 | 被调用方 | 场景 |
|--------|----------|------|
| 所有服务 | User | 身份验证、权限校验 |
| 业务服务 | Custody | 交易签名、余额查询 |
| 业务服务 | Compliance | 交易筛查、KYC状态 |

### 异步通信 (RabbitMQ事件)

| 交换机 | 事件 | 发布者 | 消费者 |
|--------|------|--------|--------|
| user.events | UserRegistered | user | compliance, notification |
| stablecoin.events | MintCompleted | stablecoin | reserve, stats |
| lending.events | LiquidationExecuted | lending | notification, audit |
| compliance.events | AccountFrozen | compliance | 所有业务服务 |

## 架构决策记录

| ADR | 标题 | 状态 |
|-----|------|------|
| ADR-001 | 微服务架构选型 | 已接受 |
| ADR-002 | 事件驱动通信 | 已接受 |
| ADR-003 | 多链支持策略 | 已接受 |
| ADR-004 | MPC vs HSM密钥方案 | 已接受 |
| ADR-005 | 合规服务权限模型 | 已接受 |

→ 详见 [architecture/decisions/](./architecture/decisions/)

## 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 后端 | Java 17 + Spring Boot 3.x | 所有微服务 |
| 数据库 | PostgreSQL | 业务数据 |
| 缓存 | Redis | 会话/限流/缓存 |
| 消息队列 | RabbitMQ | 事件驱动 |
| 搜索 | Elasticsearch | 日志/审计 |
| 链交互 | Web3j | Java链上交互 |
| 合约 | Solidity + Hardhat | 智能合约 |
| 安全 | HSM + MPC | 密钥管理 |
| 部署 | Kubernetes | 容器编排 |

## 安全架构

```
┌─────────────────────────────────────────────────────┐
│                  应用层安全                          │
│  JWT认证 | RBAC授权 | API限流 | 输入验证            │
├─────────────────────────────────────────────────────┤
│                  业务层安全                          │
│  交易监控 | 风险评估 | 合规检查 | 审计日志          │
├─────────────────────────────────────────────────────┤
│                  密钥层安全                          │
│  HSM存储 | MPC签名 | 多签审批 | 密钥轮换            │
├─────────────────────────────────────────────────────┤
│                  网络层安全                          │
│  TLS加密 | VPN隔离 | WAF防护 | DDoS防护            │
└─────────────────────────────────────────────────────┘
```
