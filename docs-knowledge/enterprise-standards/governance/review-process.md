# 技术评审流程 (Technical Review Process)

**版本**: 1.1.0
**最后更新**: 2025-12-01
**负责人**: @架构委员会

---

## 概述

本文档定义了技术决策的评审流程，确保重大技术决策经过充分讨论和验证。所有评审必须验证章程符合性。

---

## 评审类型

| 类型 | 触发条件 | 评审人 | SLA |
|------|----------|--------|-----|
| **架构评审** | 新服务、重大重构 | 架构委员会 | 5工作日 |
| **技术选型评审** | 引入新技术栈 | 架构委员会 | 3工作日 |
| **安全评审** | 涉及安全相关变更 | 安全团队 | 3工作日 |
| **代码评审** | 所有代码变更 | 团队成员 | 1工作日 |
| **章程合规评审** | 所有 PR/代码审查 | Peer Reviewer | 1工作日 |

---

## 质量门禁 (强制)

所有代码变更必须通过以下质量门禁：

| 检查项 | 要求 | 工具 |
|--------|------|------|
| 测试覆盖率 | 核心业务 ≥ 80%，工具类 ≥ 90% | JaCoCo |
| 静态检查 | 零严重/高危问题 | Checkstyle |
| Bug 检测 | 零严重/高危问题 | SpotBugs |
| 代码质量 | A/B 级评分 | SonarQube |
| 安全扫描 | 无已知漏洞 | OWASP Dependency-Check |
| 性能基准 | 关键接口 < 200ms (P95) | JMeter/Gatling |
| 审计完整性 | 关键操作有审计日志 | 人工审查 |

---

## 章程合规检查清单

每个 PR/代码审查必须验证以下章程符合性：

### TDD 合规 (原则 I)

- [ ] 每个 Controller/Service/Mapper 有对应测试类
- [ ] 公共方法有正常 + 异常场景测试
- [ ] 使用 AAA 模式 + AssertJ 断言
- [ ] 无 @Disabled、TODO、注释掉的测试

### 架构合规 (原则 II, III)

- [ ] 遵循 Controller → Service → Mapper 分层
- [ ] 无跨层调用
- [ ] 目录结构符合规则定义
- [ ] 使用 MyBatis 注解模式（非 JPA）

### 安全合规 (原则 IV)

- [ ] 所有输入使用 @Valid 校验
- [ ] 无空 catch 块
- [ ] 敏感信息未输出到日志
- [ ] 关键操作有审计日志

### API 合规 (原则 V)

- [ ] 仅使用 GET/POST 方法
- [ ] 响应使用 CommonResponse<T> 封装
- [ ] 分页使用 POST + CommonPageRequest
- [ ] 有 OpenAPI 文档注解

### 代码完整性 (原则 VI)

- [ ] 无 TODO 标记
- [ ] 无占位代码/简化实现
- [ ] 完整的错误处理和日志记录

### 事件驱动合规 (原则 IX)

- [ ] 事件监听器放在 listener/ 目录
- [ ] AOP 切面放在 aspect/ 目录
- [ ] 事件处理器支持幂等性
- [ ] 审计消息通过 RabbitMQ 异步发送

---

## 架构评审流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  提交申请   │ ──→ │  初步评估   │ ──→ │  评审会议   │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                    ┌─────────────┐            │
                    │  执行实施   │ ←─────────┘
                    └─────────────┘
                          │
                    ┌─────────────┐
                    │  跟踪验证   │
                    └─────────────┘
```

### 1. 提交申请

**必须材料**:
- [ ] 架构设计文档
- [ ] ADR（架构决策记录）
- [ ] 风险评估
- [ ] 迁移计划（如适用）
- [ ] **章程合规声明** (新增)
- [ ] **复杂性论证** (如引入新模式/技术)

### 2. 初步评估

评审人在 2 个工作日内完成初步评估：
- 材料完整性检查
- **章程符合性预检**
- 初步可行性判断
- 确定评审会议时间

### 3. 评审会议

**参与者**:
- 申请人
- 架构委员会代表
- 相关技术专家
- 安全代表（如需要）

**议程**:
1. 申请人陈述（15分钟）
2. **章程合规性审查**（10分钟）
3. 问答环节（20分钟）
4. 闭门讨论（15分钟）
5. 结论宣布

### 4. 评审结论

| 结论 | 含义 | 后续 |
|------|------|------|
| **批准** | 可以执行 | 按计划实施 |
| **有条件批准** | 需满足特定条件 | 满足条件后执行 |
| **驳回** | 不予批准 | 可修改后重新申请 |
| **延期** | 需要更多信息 | 补充后再议 |
| **章程例外** | 需要偏离章程 | 技术委员会审批 |

---

## 技术选型评审

### 评审标准

| 维度 | 权重 | 评估项 |
|------|------|--------|
| **章程符合性** | 30% | 是否在 ADOPT/TRIAL 清单，是否违反 HOLD |
| **技术成熟度** | 20% | 版本稳定性、社区活跃度、文档质量 |
| **团队能力** | 15% | 学习曲线、现有技能匹配 |
| **生态兼容性** | 15% | 与现有技术栈的集成 |
| **长期维护** | 10% | 许可证、供应商支持 |
| **性能与安全** | 10% | 性能基准、安全特性 |

### 技术雷达对照

新技术选型必须对照技术雷达：

| 雷达状态 | 选型决策 |
|----------|----------|
| ADOPT | 直接使用，无需额外审批 |
| TRIAL | 需要 POC 验证 + 架构评审 |
| ASSESS | 需要完整评估流程 + 技术委员会审批 |
| HOLD | **禁止使用**，需要例外审批 |

### 提交模板

```markdown
# 技术选型申请: [技术名称]

## 1. 背景
[为什么需要引入新技术]

## 2. 技术雷达状态
- [ ] ADOPT
- [ ] TRIAL
- [ ] ASSESS
- [ ] HOLD (需例外审批)

## 3. 章程符合性声明
[说明如何符合九大原则，或需要哪些例外]

## 4. 候选方案对比
| 方案 | 优势 | 劣势 | 成本 | 章程符合性 |
|------|------|------|------|------------|
| 方案A | | | | |
| 方案B | | | | |

## 5. 推荐方案
[推荐的技术及理由]

## 6. 风险评估
[潜在风险及应对措施]

## 7. 实施计划
[POC计划、迁移计划、时间表]
```

---

## 代码评审规范

### 评审重点

| 层面 | 检查项 | 章程关联 |
|------|--------|----------|
| **TDD 合规** | 测试覆盖率、测试质量 | 原则 I |
| **架构合规** | 分层结构、目录规范 | 原则 II, III |
| **功能正确性** | 逻辑正确、边界处理 | 原则 VI |
| **安全合规** | 输入验证、敏感数据 | 原则 IV |
| **API 合规** | HTTP 方法、响应格式 | 原则 V |
| **事件驱动** | 监听器、切面、幂等性 | 原则 IX |

### 评审流程

1. **提交PR**: 包含清晰的描述和关联Issue
2. **自动检查**: CI通过（lint、test、build、覆盖率）
3. **质量门禁**: 通过所有质量门禁检查
4. **章程合规**: 完成章程合规检查清单
5. **人工评审**: 至少1位Reviewer批准
6. **合并**: Squash merge 到主分支

### 评审礼仪

**评审人**:
- 及时响应（24小时内）
- 给出具体、建设性的建议
- 区分"必须修改"（章程违规）和"建议修改"
- **章程违规必须标记为 blocking**

**提交人**:
- 保持PR小而聚焦
- 回复所有评论
- 及时更新代码
- **提交前完成自检清单**

---

## 异常处理

### 规则冲突

规则冲突时按优先级解决：L0 > L1 > L2 > L3 > L4

同层级内 `alwaysApply=true` 优先

### 技术债务

必须在 plan.md 的 Complexity Tracking 章节中记录和论证

### 架构偏差

需技术委员会审批（如引入新的中间件、修改核心架构）

---

## 变更历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-11-30 | 初始版本 | @架构委员会 |
| 1.1.0 | 2025-12-01 | 新增章程合规检查、质量门禁、技术雷达对照 | @架构委员会 |
