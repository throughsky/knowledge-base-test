# 技术评审流程 (Technical Review Process)

**版本**: 2.0.0
**最后更新**: 2025-12-01
**负责人**: @架构委员会

---

## 概述

本文档定义了技术决策的评审流程，确保重大技术决策经过充分讨论和验证。所有评审必须验证章程符合性。

---

## 评审类型

| 类型 | 触发条件 | 评审人 | SLA |
|------|----------|--------|-----|
| **架构评审** | 新服务、重大重构 | 架构委员会 | 5工作日 |
| **技术选型评审** | 引入新技术栈 | 架构委员会 | 3工作日 |
| **安全评审** | 涉及安全相关变更 | 安全团队 | 3工作日 |
| **代码评审** | 所有代码变更 | 团队成员 | 1工作日 |
| **章程合规评审** | 所有 PR/代码审查 | Peer Reviewer | 1工作日 |

---

## 质量门禁 (强制)

所有代码变更必须通过以下质量门禁：

| 检查项 | 要求 | 工具 |
|--------|------|------|
| 测试覆盖率 | 核心业务 ≥ 80%，工具类 ≥ 90% | JaCoCo |
| 静态检查 | 零严重/高危问题 | Checkstyle |
| Bug 检测 | 零严重/高危问题 | SpotBugs |
| 代码质量 | A/B 级评分 | SonarQube |
| 安全扫描 | 无已知漏洞 | OWASP Dependency-Check |
| 性能基准 | 关键接口 < 200ms (P95) | JMeter/Gatling |
| 审计完整性 | 关键操作有审计日志 | 人工审查 |

---

## 章程合规检查清单

每个 PR/代码审查必须验证以下章程符合性：

### TDD 合规 (原则 I)

- [ ] 每个 Controller/Service/Mapper 有对应测试类
- [ ] 公共方法有正常 + 异常场景测试
- [ ] 使用 AAA 模式 + AssertJ 断言
- [ ] 无 @Disabled、TODO、注释掉的测试

### 架构合规 (原则 II, III)

- [ ] 遵循 Controller → Service → Mapper 分层
- [ ] 无跨层调用
- [ ] 目录结构符合规则定义
- [ ] 使用 MyBatis 注解模式（非 JPA）

### 安全合规 (原则 IV)

- [ ] 所有输入使用 @Valid 校验
- [ ] 无空 catch 块
- [ ] 敏感信息未输出到日志
- [ ] 关键操作有审计日志

### API 合规 (原则 V)

- [ ] 仅使用 GET/POST 方法
- [ ] 响应使用 CommonResponse<T> 封装
- [ ] 分页使用 POST + CommonPageRequest
- [ ] 有 OpenAPI 文档注解

### 代码完整性 (原则 VI)

- [ ] 无 TODO 标记
- [ ] 无占位代码/简化实现
- [ ] 完整的错误处理和日志记录

### 事件驱动合规 (原则 IX)

- [ ] 事件监听器放在 listener/ 目录
- [ ] AOP 切面放在 aspect/ 目录
- [ ] 事件处理器支持幂等性
- [ ] 审计消息通过 RabbitMQ 异步发送

### SOLID 设计原则合规 (原则 VII)

#### 单一职责原则 (SRP)
- [ ] 每个类只负责一个职责或功能
- [ ] 类的变更原因不超过一种
- [ ] 未过度拆分导致内聚性降低

#### 开放-关闭原则 (OCP)
- [ ] 新功能通过扩展实现，而非修改已有代码
- [ ] 使用多态、依赖注入或设计模式扩展功能
- [ ] 基于接口编程而非实现编程

#### 里氏替换原则 (LSP)
- [ ] 子类可替换父类出现的任何位置
- [ ] 子类未改变父类原有功能的契约
- [ ] 继承关系符合"is-a"语义

#### 接口隔离原则 (ISP)
- [ ] 接口职责单一，无冗余方法
- [ ] 调用方不依赖不需要的接口方法
- [ ] 大接口已按职责拆分为小接口

#### 依赖反转原则 (DIP)
- [ ] 高层模块依赖抽象而非具体实现
- [ ] 使用依赖注入而非直接 new 对象
- [ ] 面向接口编程

### 设计模式合规检查

- [ ] 创建型：复杂对象使用工厂/建造者模式
- [ ] 结构型：功能扩展使用装饰者/代理模式而非继承
- [ ] 行为型：条件分支使用策略/状态模式替代 if-else
- [ ] 组合优先于继承
- [ ] 设计模式使用有明确的问题场景支撑

### 编码技巧合规检查

#### 方法级规范
- [ ] 方法长度不超过 80 行
- [ ] 方法内语句在同一抽象层级
- [ ] 参数数量不超过 5 个（否则使用参数对象）
- [ ] 无对参数的直接赋值修改

#### 条件判断规范
- [ ] 使用卫语句替代深层嵌套
- [ ] 复杂条件使用多态或策略模式
- [ ] 无超过 3 层的条件嵌套

#### 异常处理规范
- [ ] 使用异常而非错误码表示异常状态
- [ ] 异常在最上层统一处理（@ControllerAdvice）
- [ ] finally 块只做资源关闭操作
- [ ] 无空 catch 块（与安全合规重叠，强调）

#### 空值处理规范
- [ ] 使用 Optional 处理可能为空的返回值
- [ ] 集合返回空集合而非 null
- [ ] 关键位置有空值防护

#### 类设计规范
- [ ] 类职责单一，高内聚低耦合
- [ ] 优先使用组合而非继承
- [ ] 成员可访问性最小化
- [ ] 不可变类设计（如适用）

#### 并发与性能规范
- [ ] 线程间共享变量使用 volatile 或同步机制
- [ ] 锁的使用范围最小化
- [ ] 分布式锁设置过期时间和超时时间
- [ ] 集合初始化指定容量
- [ ] 无循环调用数据库（批量查询 + Map 匹配）
- [ ] 远程调用设置超时时间

---

## 架构评审流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  提交申请   │ ──→ │  初步评估   │ ──→ │  评审会议   │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                    ┌─────────────┐            │
                    │  执行实施   │ ←─────────┘
                    └─────────────┘
                          │
                    ┌─────────────┐
                    │  跟踪验证   │
                    └─────────────┘
```

### 1. 提交申请

**必须材料**:
- [ ] 架构设计文档
- [ ] ADR（架构决策记录）
- [ ] 风险评估
- [ ] 迁移计划（如适用）
- [ ] **章程合规声明** (新增)
- [ ] **复杂性论证** (如引入新模式/技术)

### 2. 初步评估

评审人在 2 个工作日内完成初步评估：
- 材料完整性检查
- **章程符合性预检**
- 初步可行性判断
- 确定评审会议时间

### 3. 评审会议

**参与者**:
- 申请人
- 架构委员会代表
- 相关技术专家
- 安全代表（如需要）

**议程**:
1. 申请人陈述（15分钟）
2. **章程合规性审查**（10分钟）
3. 问答环节（20分钟）
4. 闭门讨论（15分钟）
5. 结论宣布

### 4. 评审结论

| 结论 | 含义 | 后续 |
|------|------|------|
| **批准** | 可以执行 | 按计划实施 |
| **有条件批准** | 需满足特定条件 | 满足条件后执行 |
| **驳回** | 不予批准 | 可修改后重新申请 |
| **延期** | 需要更多信息 | 补充后再议 |
| **章程例外** | 需要偏离章程 | 技术委员会审批 |

---

## 技术选型评审

### 评审标准

| 维度 | 权重 | 评估项 |
|------|------|--------|
| **章程符合性** | 30% | 是否在 ADOPT/TRIAL 清单，是否违反 HOLD |
| **技术成熟度** | 20% | 版本稳定性、社区活跃度、文档质量 |
| **团队能力** | 15% | 学习曲线、现有技能匹配 |
| **生态兼容性** | 15% | 与现有技术栈的集成 |
| **长期维护** | 10% | 许可证、供应商支持 |
| **性能与安全** | 10% | 性能基准、安全特性 |

### 技术雷达对照

新技术选型必须对照技术雷达：

| 雷达状态 | 选型决策 |
|----------|----------|
| ADOPT | 直接使用，无需额外审批 |
| TRIAL | 需要 POC 验证 + 架构评审 |
| ASSESS | 需要完整评估流程 + 技术委员会审批 |
| HOLD | **禁止使用**，需要例外审批 |

### 提交模板

```markdown
# 技术选型申请: [技术名称]

## 1. 背景
[为什么需要引入新技术]

## 2. 技术雷达状态
- [ ] ADOPT
- [ ] TRIAL
- [ ] ASSESS
- [ ] HOLD (需例外审批)

## 3. 章程符合性声明
[说明如何符合九大原则，或需要哪些例外]

## 4. 候选方案对比
| 方案 | 优势 | 劣势 | 成本 | 章程符合性 |
|------|------|------|------|------------|
| 方案A | | | | |
| 方案B | | | | |

## 5. 推荐方案
[推荐的技术及理由]

## 6. 风险评估
[潜在风险及应对措施]

## 7. 实施计划
[POC计划、迁移计划、时间表]
```

---

## 代码评审规范

### 双层审查机制

```
┌─────────────────────────────────────────────────────────────┐
│                    Code Review 双层机制                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              第一层：AI 自动化审查                    │   │
│  │  • 静态代码分析 (SonarQube/Checkstyle)              │   │
│  │  • 单元测试覆盖率检查                                │   │
│  │  • 安全漏洞扫描                                     │   │
│  │  • 代码风格一致性                                   │   │
│  │  • SOLID 原则检测                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              第二层：Human Reviewer                  │   │
│  │  • 业务逻辑正确性                                   │   │
│  │  • 架构设计合理性                                   │   │
│  │  • 可维护性评估                                     │   │
│  │  • 知识传递与反馈                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 评审重点

| 层面 | 检查项 | 章程关联 | 审查层 |
|------|--------|----------|--------|
| **TDD 合规** | 测试覆盖率、测试质量 | 原则 I | AI + Human |
| **架构合规** | 分层结构、目录规范 | 原则 II, III | AI + Human |
| **功能正确性** | 逻辑正确、边界处理 | 原则 VI | Human |
| **安全合规** | 输入验证、敏感数据 | 原则 IV | AI + Human |
| **API 合规** | HTTP 方法、响应格式 | 原则 V | AI |
| **事件驱动** | 监听器、切面、幂等性 | 原则 IX | Human |
| **SOLID 原则** | 设计原则遵循 | 原则 VII | AI + Human |
| **编码规范** | 方法、条件、异常、空值 | 原则 VIII | AI |
| **性能合规** | 并发、数据库、远程调用 | - | AI + Human |

### 评审流程

```
┌─────────────┐
│  开发完成   │
└──────┬──────┘
       ↓
┌─────────────┐     ┌─────────────┐
│  自检清单   │ ──→ │  提交 PR    │
│  (必须完成) │     │  关联 Issue │
└─────────────┘     └──────┬──────┘
                           ↓
                   ┌─────────────┐
                   │  CI 自动化  │
                   │  质量门禁   │
                   └──────┬──────┘
                          ↓
              ┌───────────┴───────────┐
              ↓                       ↓
       ┌─────────────┐         ┌─────────────┐
       │   通过      │         │   失败      │
       └──────┬──────┘         └──────┬──────┘
              ↓                       ↓
       ┌─────────────┐         ┌─────────────┐
       │ Human Review│         │  修复问题   │
       └──────┬──────┘         └─────────────┘
              ↓
       ┌─────────────┐
       │   合并      │
       │ Squash Merge│
       └─────────────┘
```

**详细步骤**：
1. **自检清单**: 提交前完成章程合规检查清单（必须）
2. **提交PR**: 包含清晰的描述和关联Issue
3. **自动检查**: CI通过（lint、test、build、覆盖率、安全扫描）
4. **质量门禁**: 通过所有质量门禁检查
5. **章程合规**: AI 自动验证章程合规检查项
6. **人工评审**: 至少1位Reviewer批准，重点关注业务逻辑和架构
7. **合并**: Squash merge 到主分支

### 评审礼仪

**评审人**:
- 及时响应（24小时内）
- 给出具体、建设性的建议
- 区分"必须修改"（章程违规）和"建议修改"
- **章程违规必须标记为 blocking**
- 关注代码可维护性和可读性
- 提供学习性反馈，促进团队成长

**提交人**:
- 保持PR小而聚焦（建议不超过 400 行变更）
- 回复所有评论
- 及时更新代码
- **提交前完成自检清单**
- 提供足够的上下文说明变更原因

### AI 辅助评审配置

| 工具 | 检查项 | 阈值 |
|------|--------|------|
| **SonarQube** | 代码异味、重复代码、复杂度 | A/B 级 |
| **Checkstyle** | 代码风格、命名规范 | 零违规 |
| **SpotBugs** | 潜在 Bug、空指针风险 | 零高危 |
| **JaCoCo** | 测试覆盖率 | ≥80% |
| **OWASP DC** | 依赖安全漏洞 | 零已知漏洞 |
| **PMD** | 代码规范、最佳实践 | 零严重 |

---

## 异常处理

### 规则冲突

规则冲突时按优先级解决：L0 > L1 > L2 > L3 > L4

同层级内 `alwaysApply=true` 优先

### 技术债务

必须在 plan.md 的 Complexity Tracking 章节中记录和论证

### 架构偏差

需技术委员会审批（如引入新的中间件、修改核心架构）

---

## 变更历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-11-30 | 初始版本 | @架构委员会 |
| 1.1.0 | 2025-12-01 | 新增章程合规检查、质量门禁、技术雷达对照 | @架构委员会 |
| 2.0.0 | 2025-12-01 | 新增 SOLID 设计原则检查清单、设计模式合规检查、编码技巧合规检查；增强代码评审规范（双层审查机制、评审流程图、AI辅助配置） | @架构委员会 |
