# 架构原则

**版本**: 1.1.0
**状态**: 已发布
**最后更新**: 2025-12-01

---

## 九大核心原则

### 原则 I：测试驱动开发 (TDD) - 强制执行

**要求**：所有代码必须遵循测试驱动开发流程，测试优先，实现在后。

| 要求项 | 标准 |
|--------|------|
| 测试覆盖 | 每个 Controller、Service、Mapper 都必须有对应测试类 |
| 方法覆盖 | 所有公共方法必须有测试用例（正常 + 异常场景） |
| 覆盖率 | 核心业务 ≥ 80%，工具类 ≥ 90% |
| 测试模式 | AAA 模式（Arrange-Act-Assert）+ AssertJ 断言 |
| 幂等性 | @BeforeEach 准备数据，@AfterEach 清理数据 |
| 禁止项 | 禁止跳过测试、TODO 标记、注释掉测试代码 |

**理由**：金融级系统要求零容错，TDD 确保代码质量和业务逻辑正确性。

---

### 原则 II：规则至上架构

**要求**：`.cursor/rules/` 中定义的规则高于任何其他考虑，必须零偏差执行。

| 规则层级 | 优先级 | 说明 |
|----------|--------|------|
| L0 | 最高 | 交互规范 |
| L1 | 高 | 项目结构 |
| L2 | 中 | 设计标准 |
| L3 | 低 | 编码规范 |
| L4 | 最低 | 文件约定 |

**冲突解决**：L0 > L1 > L2 > L3 > L4；同层级 `alwaysApply=true` 优先

---

### 原则 III：微服务架构纯粹性

**要求**：项目必须符合微服务架构原则，支持移动端和 PC 端后台服务。

| 约束 | 要求 |
|------|------|
| 技术栈 | Spring Boot 3.x + Gradle ≥ 8.14 |
| 分层 | Controller → Service → Mapper，禁止跨层调用 |
| 数据访问 | MyBatis 注解模式 |
| 响应封装 | 所有 API 使用 `CommonResponse<T>` |
| HTTP 方法 | 仅使用 GET 和 POST |
| 分页查询 | POST + `CommonPageRequest` 继承类 |
| 禁止项 | 禁止 Maven，禁止多构建工具 |

---

### 原则 IV：金融级安全优先

**要求**：作为稳定币产品后台服务，安全性是第一优先级。

| 安全项 | 要求 |
|--------|------|
| 输入校验 | 所有输入必须使用 `@Valid` |
| 异常处理 | 具体异常类型，禁止空 catch 块 |
| 敏感信息 | 加密存储和传输 |
| 审计日志 | 记录操作人、时间、内容、结果 |
| 日志记录 | 关键入口、核心步骤、异常处记录 |
| 地址验证 | 自定义验证器严格验证区块链地址 |
| 禁止项 | 禁止输出敏感信息到日志或响应 |

---

### 原则 V：RESTful API 标准化

**要求**：所有 HTTP 接口必须遵循 RESTful 原则和项目约定。

| 规范项 | 要求 |
|--------|------|
| 路径设计 | 资源化路径，如 `/users` 而非 `/getUsers` |
| HTTP 方法 | 仅 GET（简单查询）和 POST（复杂查询/修改） |
| 禁止方法 | 禁止 PUT、DELETE、PATCH |
| 响应格式 | `CommonResponse<T>` 统一封装 |
| 参数规范 | 参数超过两个必须使用 POST + 请求对象 |
| 文档 | OpenAPI 3（Springdoc）生成 |
| 状态码 | 200 成功，400 参数错误，500 服务器错误 |

---

### 原则 VI：生产就绪代码完整性

**要求**：所有提交的代码必须符合生产环境标准。

| 质量项 | 要求 |
|--------|------|
| 可运行 | 代码必须可编译、可运行、可测试 |
| 禁止项 | 禁止 TODO 标记、简化实现、占位代码 |
| 完整性 | 完整的错误处理、日志记录、参数验证 |
| 依赖注入 | 使用 `@Autowired` 字段注入 |
| 事务管理 | 合理使用 `@Transactional` |
| 设计模式 | 遵循 SOLID 原则，使用 Builder、Factory、Strategy 等 |

---

### 原则 VII：多平台后台架构

**要求**：后台服务必须同时支持移动端和 PC 端访问。

| 设计项 | 要求 |
|--------|------|
| 网络环境 | 考虑移动端超时、重试、幂等性 |
| 响应数据 | 简洁高效，避免冗余字段 |
| 版本控制 | URL 路径或 Header 版本 |
| 错误处理 | 统一的错误码和错误信息 |
| 分页支持 | 避免大数据量传输 |
| 逻辑共享 | 移动端和 PC 端共享相同业务逻辑层 |

---

### 原则 VIII：简洁性原则 (YAGNI & KISS)

**要求**：保持系统简单，避免过度设计。

| 约束 | 要求 |
|------|------|
| 目录创建 | 不允许创建规则未定义的目录 |
| 依赖管理 | 禁止引入未使用的依赖 |
| 功能实现 | 优先使用 Spring Boot 内置功能 |
| 设计模式 | 必须有明确业务场景支撑 |
| 抽象层次 | 避免过度抽象和过早优化 |
| 配置管理 | 外部化（application.yml），支持 dev/prod |

---

### 原则 IX：事件驱动与审计追踪

**要求**：系统必须采用事件驱动模式实现业务解耦和全链路审计追踪。

| 实现项 | 要求 |
|--------|------|
| 工作流事件 | Activiti 事件监听器（ExecutionListener、TaskListener） |
| 审计消息 | 通过 RabbitMQ 异步发送，不阻塞业务 |
| AOP 切面 | 用户身份追踪、Web 日志、操作审计 |
| 外部回调 | 实现回调机制处理外部服务异步响应 |
| 缓存事件 | @CacheEvict、@CachePut 管理缓存失效 |
| 命名规范 | 事件监听器明确命名，如 `ApprovalNodeCompletedListener` |
| 幂等性 | 所有事件处理器必须支持幂等性 |

**关键实现模式**：
- 审批流程：节点完成 → 审计消息 → 触发回调 → 更新状态
- 用户追踪：`InitiatorUserIdAspect` 自动注入用户 ID
- Web 日志：`WebLogAspect` 记录请求/响应/性能
- 缓存策略：流程定义 1 小时，用户信息 30 秒

---

## 通用架构原则

### 12-Factor App

| 要素 | 要求 |
|------|------|
| 配置 | 环境变量，禁止硬编码 |
| 进程 | 无状态，会话外部存储 |
| 日志 | 结构化JSON输出 |
| 并发 | 水平扩展能力 |

### 领域驱动设计

| 概念 | 应用 |
|------|------|
| 限界上下文 | 微服务边界 |
| 聚合根 | 事务边界 |
| 领域事件 | 服务间通信 |

### API 优先

```
OpenAPI设计 → 评审 → Mock → 并行开发 → 契约测试
```

### 可观测性

| 支柱 | 要求 |
|------|------|
| 日志 | 结构化JSON，含traceId |
| 指标 | Prometheus格式暴露 |
| 追踪 | 分布式追踪头传递 |

### 安全内建

- 认证：OAuth 2.0 / OIDC
- 授权：RBAC/ABAC，最小权限
- 数据：传输TLS，存储加密
- 输入：全部验证，防注入
