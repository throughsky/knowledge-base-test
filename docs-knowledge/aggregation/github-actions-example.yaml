# .github/workflows/knowledge-aggregation.yml
# å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ°çŸ¥è¯†åº“ä»“åº“çš„ .github/workflows/ ç›®å½•

name: Knowledge Aggregation

on:
  # å®šæ—¶è§¦å‘: æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹ (UTC)
  schedule:
    - cron: '0 2 * * 1'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'èšåˆæ¨¡å¼'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full
      skip_code_derived:
        description: 'è·³è¿‡ code-derived æ”¶é›†'
        required: false
        default: false
        type: boolean
      all_modules:
        description: 'æ”¶é›†æ‰€æœ‰æ¨¡å—æ–‡æ¡£'
        required: false
        default: false
        type: boolean

  # å­ä»“åº“ webhook è§¦å‘ (éœ€é…ç½® repository_dispatch)
  repository_dispatch:
    types: [knowledge-update, code-derived-update]

env:
  REPOS: |
    user-service
    bridge-service
    stablecoin-service
    rwa-service
    tokenization-service
    lending-service
    staking-service
    custody-service
    compliance-service

jobs:
  aggregate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout knowledge base
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup jq for JSON processing
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Clone sub-repositories
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p repos
          for repo in $REPOS; do
            echo "Cloning $repo..."
            git clone --depth 1 \
              https://github.com/${{ github.repository_owner }}/$repo.git \
              repos/$repo || echo "Warning: Failed to clone $repo"
          done

      - name: Collect context.md changes
        id: collect_context
        run: |
          changes=""
          for repo in $REPOS; do
            context_file="repos/$repo/.knowledge/context.md"
            if [[ -f "$context_file" ]]; then
              # è®¡ç®—æ–‡ä»¶hashç”¨äºå˜æ›´æ£€æµ‹
              hash=$(md5sum "$context_file" | cut -d' ' -f1)
              echo "$repo context.md: $hash"
              changes="$changes $repo"
            fi
          done
          echo "changed_repos=$changes" >> $GITHUB_OUTPUT

      - name: Collect code-derived documents
        id: collect_code_derived
        if: ${{ github.event.inputs.skip_code_derived != 'true' }}
        run: |
          code_derived_repos=""
          total_components=0

          mkdir -p docs-knowledge/aggregation/cache/code-derived

          for repo in $REPOS; do
            code_derived_dir="repos/$repo/.knowledge/code-derived"
            if [[ -d "$code_derived_dir" ]]; then
              echo "Collecting code-derived from $repo..."

              # åˆ›å»ºä»“åº“ç¼“å­˜ç›®å½•
              repo_cache="docs-knowledge/aggregation/cache/code-derived/$repo"
              mkdir -p "$repo_cache"

              # æ”¶é›†æ ¸å¿ƒæ–‡ä»¶
              for file in metadata.json overview.md module_tree.json; do
                if [[ -f "$code_derived_dir/$file" ]]; then
                  cp "$code_derived_dir/$file" "$repo_cache/"
                  echo "  âœ“ $file"
                fi
              done

              # å¯é€‰: æ”¶é›†æ‰€æœ‰æ¨¡å—æ–‡æ¡£
              if [[ "${{ github.event.inputs.all_modules }}" == "true" ]]; then
                for module_file in "$code_derived_dir"/*.md; do
                  if [[ -f "$module_file" && "$(basename "$module_file")" != "overview.md" ]]; then
                    cp "$module_file" "$repo_cache/"
                    echo "  âœ“ $(basename "$module_file")"
                  fi
                done
              fi

              # æå–ç»Ÿè®¡ä¿¡æ¯
              if [[ -f "$repo_cache/metadata.json" ]]; then
                components=$(jq -r '.statistics.total_components // 0' "$repo_cache/metadata.json")
                total_components=$((total_components + components))
              fi

              code_derived_repos="$code_derived_repos $repo"
            fi
          done

          echo "code_derived_repos=$code_derived_repos" >> $GITHUB_OUTPUT
          echo "total_components=$total_components" >> $GITHUB_OUTPUT

      - name: Generate aggregation summary
        id: summary
        run: |
          echo "## ğŸ“Š èšåˆç»Ÿè®¡" > aggregation_summary.md
          echo "" >> aggregation_summary.md
          echo "| ä»“åº“ | context.md | code-derived | ç»„ä»¶æ•° |" >> aggregation_summary.md
          echo "|------|------------|--------------|--------|" >> aggregation_summary.md

          for repo in $REPOS; do
            has_context="âŒ"
            has_code_derived="âŒ"
            components="-"

            if [[ -f "repos/$repo/.knowledge/context.md" ]]; then
              has_context="âœ…"
            fi

            cache_dir="docs-knowledge/aggregation/cache/code-derived/$repo"
            if [[ -d "$cache_dir" ]]; then
              has_code_derived="âœ…"
              if [[ -f "$cache_dir/metadata.json" ]]; then
                components=$(jq -r '.statistics.total_components // "-"' "$cache_dir/metadata.json")
              fi
            fi

            echo "| $repo | $has_context | $has_code_derived | $components |" >> aggregation_summary.md
          done

          echo "" >> aggregation_summary.md
          echo "**æ€»ç»„ä»¶æ•°**: ${{ steps.collect_code_derived.outputs.total_components || 0 }}" >> aggregation_summary.md

      - name: Run AI aggregation
        if: steps.collect_context.outputs.changed_repos != '' || steps.collect_code_derived.outputs.code_derived_repos != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # æ„å»ºèšåˆè„šæœ¬å‚æ•°
          ARGS="--mode ${{ github.event.inputs.mode || 'incremental' }}"

          if [[ "${{ github.event.inputs.skip_code_derived }}" == "true" ]]; then
            ARGS="$ARGS --skip-code-derived"
          fi

          if [[ "${{ github.event.inputs.all_modules }}" == "true" ]]; then
            ARGS="$ARGS --all-modules"
          fi

          # æ‰§è¡Œèšåˆè„šæœ¬
          ./docs-knowledge/aggregation/scripts/aggregate.sh $ARGS

      - name: Create Pull Request
        if: steps.collect_context.outputs.changed_repos != '' || steps.collect_code_derived.outputs.code_derived_repos != ''
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: çŸ¥è¯†åº“è‡ªåŠ¨èšåˆæ›´æ–° (å« code-derived)"
          title: "[è‡ªåŠ¨] çŸ¥è¯†åº“èšåˆæ›´æ–° - ${{ github.run_number }}"
          body: |
            ## ğŸ“š çŸ¥è¯†åº“è‡ªåŠ¨èšåˆ

            **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
            **èšåˆæ¨¡å¼**: ${{ github.event.inputs.mode || 'incremental' }}
            **Code-Derived**: ${{ github.event.inputs.skip_code_derived == 'true' && 'è·³è¿‡' || 'å·²æ”¶é›†' }}

            ### ğŸ“ Context å˜æ›´
            ${{ steps.collect_context.outputs.changed_repos || 'æ— å˜æ›´' }}

            ### ğŸ¤– Code-Derived æ”¶é›†
            ${{ steps.collect_code_derived.outputs.code_derived_repos || 'æ— æ”¶é›†' }}

            **æ€»ç»„ä»¶æ•°**: ${{ steps.collect_code_derived.outputs.total_components || 0 }}

            ### ğŸ“Š èšåˆç»Ÿè®¡
            è¯·æŸ¥çœ‹ `aggregation_summary.md` äº†è§£è¯¦æƒ…

            ### å˜æ›´å†…å®¹
            è¯·æŸ¥çœ‹ Files changed äº†è§£å…·ä½“æ›´æ–°

            ---
            > ğŸ¤– æ­¤ PR ç”± AI èšåˆç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
          branch: auto/knowledge-aggregation
          labels: |
            documentation
            automated
            code-derived
          reviewers: |
            architect
            tech-lead

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#knowledge-updates'
          text: |
            çŸ¥è¯†åº“èšåˆ ${{ job.status }}
            - Context å˜æ›´: ${{ steps.collect_context.outputs.changed_repos || 'æ— ' }}
            - Code-Derived: ${{ steps.collect_code_derived.outputs.code_derived_repos || 'æ— ' }}
            - æ€»ç»„ä»¶æ•°: ${{ steps.collect_code_derived.outputs.total_components || 0 }}
            æŸ¥çœ‹: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
