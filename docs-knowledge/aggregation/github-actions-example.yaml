# .github/workflows/knowledge-aggregation.yml
# å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ°çŸ¥è¯†åº“ä»“åº“çš„ .github/workflows/ ç›®å½•

name: Knowledge Aggregation

on:
  # å®šæ—¶è§¦å‘: æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹ (UTC)
  schedule:
    - cron: '0 2 * * 1'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'èšåˆæ¨¡å¼'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full

  # å­ä»“åº“ webhook è§¦å‘ (éœ€é…ç½® repository_dispatch)
  repository_dispatch:
    types: [knowledge-update]

env:
  REPOS: |
    user-service
    bridge-service
    stablecoin-service
    rwa-service
    tokenization-service
    lending-service
    staking-service
    custody-service
    compliance-service

jobs:
  aggregate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout knowledge base
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone sub-repositories
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p repos
          for repo in $REPOS; do
            echo "Cloning $repo..."
            git clone --depth 1 \
              https://github.com/${{ github.repository_owner }}/$repo.git \
              repos/$repo || echo "Warning: Failed to clone $repo"
          done

      - name: Collect changes
        id: collect
        run: |
          changes=""
          for repo in $REPOS; do
            context_file="repos/$repo/.knowledge/context.md"
            if [[ -f "$context_file" ]]; then
              # è®¡ç®—æ–‡ä»¶hashç”¨äºå˜æ›´æ£€æµ‹
              hash=$(md5sum "$context_file" | cut -d' ' -f1)
              echo "$repo: $hash"
              changes="$changes $repo"
            fi
          done
          echo "changed_repos=$changes" >> $GITHUB_OUTPUT

      - name: Run AI aggregation
        if: steps.collect.outputs.changed_repos != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # è°ƒç”¨ Claude API è¿›è¡Œæ™ºèƒ½èšåˆ
          # æˆ–ä½¿ç”¨ claude-code CLI
          ./docs-knowledge/aggregation/scripts/aggregate.sh \
            --mode ${{ github.event.inputs.mode || 'incremental' }}

      - name: Create Pull Request
        if: steps.collect.outputs.changed_repos != ''
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: çŸ¥è¯†åº“è‡ªåŠ¨èšåˆæ›´æ–°"
          title: "[è‡ªåŠ¨] çŸ¥è¯†åº“èšåˆæ›´æ–° - ${{ github.run_number }}"
          body: |
            ## ğŸ“š çŸ¥è¯†åº“è‡ªåŠ¨èšåˆ

            **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
            **èšåˆæ¨¡å¼**: ${{ github.event.inputs.mode || 'incremental' }}

            ### æ‰«æçš„ä»“åº“
            ${{ steps.collect.outputs.changed_repos }}

            ### å˜æ›´å†…å®¹
            è¯·æŸ¥çœ‹ Files changed äº†è§£å…·ä½“æ›´æ–°

            ---
            > ğŸ¤– æ­¤ PR ç”± AI èšåˆç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
          branch: auto/knowledge-aggregation
          labels: |
            documentation
            automated
          reviewers: |
            architect
            tech-lead

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#knowledge-updates'
          text: |
            çŸ¥è¯†åº“èšåˆ ${{ job.status }}
            æŸ¥çœ‹: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
