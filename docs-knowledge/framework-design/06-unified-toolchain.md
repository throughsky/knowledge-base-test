# 第6章 统一工具链

## 6.1 AI 编码工具

### 6.1.1 核心 IDE 和 Agent

| 工具 | 定位 | 使用场景 |
|------|------|----------|
| **Claude Code CLI** | Base Agent | 主力开发工具，支持MCP集成 |
| **Cursor** | AI编辑器 | 日常编码，代码补全 |
| **GitHub Copilot** | 代码补全 | 辅助编码，代码建议 |

### 6.1.2 Agent 架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Agent 架构                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                 Claude Code (Base Agent)             │   │
│  │  • 子Agent调度                                       │   │
│  │  • MCP集成                                           │   │
│  │  • 通用开发工具                                      │   │
│  │  • 上下文压缩                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│          ┌───────────────┼───────────────┐                 │
│          ▼               ▼               ▼                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │
│  │ Coding Agent │ │  Test Agent  │ │ Deploy Agent │       │
│  └──────────────┘ └──────────────┘ └──────────────┘       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6.2 开发工具集成 (MCP)

通过 MCP（Model Context Protocol）将分散的工具集成：

| MCP Server | 功能 | 触发场景 |
|------------|------|----------|
| **Context7** | 官方文档查询 | 框架API、库使用方法 |
| **Sequential** | 复杂推理 | 调试、系统设计 |
| **Serena** | 语义理解 | 符号操作、项目导航 |
| **Playwright** | 浏览器测试 | E2E测试、UI验证 |

---

## 6.3 代码理解能力

**三层代码理解**：

| 层级 | 方案 | 目的 |
|------|------|------|
| **目标仓库定位** | 知识库RAG | 快速定位目标仓库 |
| **跨仓库依赖召回** | RAG + Git增量更新 | 召回依赖代码 |
| **工作区代码理解** | 文本搜索 + AST | 精确理解当前代码 |

### 6.3.1 代码分析技术栈

为支撑代码衍生文档（code-derived）的自动生成，需要多语言代码分析能力：

**语言分析器选型**：

| 语言 | 分析技术 | 分析器 | 提取能力 |
|------|----------|--------|----------|
| **Python** | 原生 AST | `ast` 模块 | 类、函数、导入、装饰器、类型注解 |
| **JavaScript** | Tree-sitter | `tree-sitter-javascript` | 函数、类、模块导出、JSDoc |
| **TypeScript** | Tree-sitter | `tree-sitter-typescript` | 类型定义、接口、泛型、装饰器 |
| **Java** | Tree-sitter | `tree-sitter-java` | 类、方法、注解、包结构 |
| **C#** | Tree-sitter | `tree-sitter-c-sharp` | 类、方法、属性、命名空间 |
| **C/C++** | Tree-sitter | `tree-sitter-c/cpp` | 函数、结构体、宏、头文件 |

**依赖图构建流程**：

```
┌─────────────────────────────────────────────────────────────────┐
│                    依赖图构建流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐           │
│  │  文件扫描   │ → │  AST解析    │ → │  节点提取   │           │
│  │  语言识别   │   │  语法树构建  │   │  类/函数/变量│           │
│  └─────────────┘   └─────────────┘   └─────────────┘           │
│                                              ↓                  │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐           │
│  │  模块聚类   │ ← │  图构建     │ ← │  调用分析   │           │
│  │  层次结构   │   │  依赖关系   │   │  导入解析   │           │
│  └─────────────┘   └─────────────┘   └─────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**核心组件**：

| 组件 | 职责 | 输出 |
|------|------|------|
| **AnalysisService** | 多语言代码分析入口 | 组件列表、调用关系 |
| **CallGraphAnalyzer** | 调用图分析 | 调用链、依赖关系 |
| **DependencyGraphBuilder** | 依赖图构建 | 模块依赖树、叶子节点 |
| **cluster_modules** | 模块聚类 | 层次化模块结构 |

---

## 6.4 长期记忆系统

```
┌─────────────────────────────────────────────────────────────┐
│                    长期记忆系统                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐ │
│  │ 记忆提取 │ → │ 记忆存储 │ → │ 记忆召回 │ → │跨会话复用│ │
│  │          │   │          │   │          │   │          │ │
│  │ 开发者与 │   │ 结构化   │   │ 相似场景 │   │ 知识持续 │ │
│  │ Agent对话│   │ 索引存储 │   │ 匹配召回 │   │ 积累     │ │
│  └──────────┘   └──────────┘   └──────────┘   └──────────┘ │
│                                                             │
│  效果对比:                                                  │
│  • 未接入记忆: 5-10轮对话修正                               │
│  • 接入记忆: 1-3轮对话                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6.5 云端沙箱

**设计要点**：

| 特性 | 说明 |
|------|------|
| **标准化环境** | 每个Agent会话分配独立沙箱 |
| **无状态化** | 会话与沙箱解耦，支持水平扩容 |
| **共享存储** | 会话状态存储在共享存储中 |
| **统一网关** | 解决安全和监管问题 |

---

## 6.6 质量工具链

```
┌─────────────────────────────────────────────────────────────┐
│                    质量工具链                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  静态分析          安全扫描           测试框架              │
│  ┌──────────┐     ┌──────────┐      ┌──────────┐           │
│  │ ESLint   │     │ Snyk     │      │ Jest     │           │
│  │ SonarQube│     │ AI SAST  │      │ Pytest   │           │
│  │ DeepCode │     │ 敏感信息 │      │Playwright│           │
│  └──────────┘     └──────────┘      └──────────┘           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6.7 CI/CD 集成

| 功能 | 说明 | AI参与方式 |
|------|------|------------|
| **自动化部署** | 持续集成部署 | AI生成部署脚本 |
| **Release Notes** | 版本发布说明 | AI根据PR/Commit自动生成 |
| **风险预测** | 高风险变更预警 | AI分析代码变动预测风险 |
| **质量门禁** | 代码质量检查 | AI辅助代码审查 |

---

## 6.8 前端 AI Coding 模式

前端开发采用 **Figma MCP 实时访问模式**，实现设计稿到代码的高效转换。

### 6.8.1 推荐模式：Figma MCP 实时访问

**核心优势**：

| 维度 | Figma MCP | 传统导出模式 | 效率提升 |
|------|-----------|--------------|----------|
| 单次代码生成 | 5分钟 | 20分钟 | **节省75%** |
| 设计变更响应 | 即时刷新 | 重新导出流程 | **快4倍** |
| 月度维护成本 | 1.5人天 | 11.5人天 | **省10人天/月** |
| 代码质量 | AI理解设计语义 | 固定尺寸硬编码 | **返工率低60%** |

**综合评分**：MCP模式 43/50 vs 导出模式 35/50

### 6.8.2 工作流程

```
┌─────────────────────────────────────────────────────────────┐
│                Figma MCP 前端开发流程                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  设计师                    AI Agent                开发者    │
│  ┌─────────┐              ┌─────────┐            ┌─────────┐│
│  │ Figma   │ ──MCP实时──→ │ 读取    │ ──生成──→ │ 审查    ││
│  │ 设计稿  │   访问       │ 设计稿  │   代码     │ 优化    ││
│  └─────────┘              └─────────┘            └─────────┘│
│       │                        │                      │     │
│       └────────────────────────┼──────────────────────┘     │
│                                │                            │
│                    设计变更即时同步，无需手工导出             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**实施步骤**（0.5人天启动）：

| 阶段 | 任务 | 时间 | 产出 |
|------|------|------|------|
| Day 1 上午 | 获取Figma Access Token | 5分钟 | Token配置 |
| Day 1 上午 | 配置AI工具MCP集成 | 10分钟 | 配置文件 |
| Day 1 上午 | 测试读取组件生成代码 | 15分钟 | 测试代码 |
| Day 1 下午 | 制定命名规范（3条规则） | 30分钟 | 规范文档 |
| Day 2 | 团队培训 | 30分钟 | 培训记录 |
| Week 2 | 试点2-3个页面 | - | 最佳实践 |

### 6.8.3 设计规范要求

**命名规范**（设计师必须遵循）：

| 层级 | 命名规则 | 示例 |
|------|----------|------|
| 页面 | `Page/功能模块` | `Page/UserProfile` |
| 组件 | `Component/组件名` | `Component/Button` |
| 元素 | `语义化名称` | `title`, `description`, `avatar` |

**设计系统要求**：

- 使用Auto Layout约束（AI生成响应式布局）
- 定义Design Token（颜色、字体、间距）
- 组件使用Variants标注状态

### 6.8.4 质量保障

**代码质量对比**：

| 质量维度 | MCP模式 | 导出模式 |
|----------|---------|----------|
| 语义理解 | ⭐⭐⭐⭐⭐ AI理解组件关系 | ⭐⭐ 仅视觉表现 |
| 响应式 | ⭐⭐⭐⭐ 基于约束生成弹性布局 | ⭐ 固定尺寸 |
| 可维护性 | ⭐⭐⭐⭐ 清晰组件拆分 | ⭐⭐ 需大量重构 |
| TypeScript | ⭐⭐⭐⭐ 推断正确类型 | ⭐⭐ 类型缺失 |

**审查清单**：

- [ ] 组件拆分符合设计系统
- [ ] 样式使用CSS变量/主题系统
- [ ] 响应式断点正确
- [ ] 无绝对定位硬编码

### 6.8.5 风险与应对

| 风险 | 概率 | 应对策略 |
|------|------|----------|
| API故障 | 低 | 缓存常用设计稿；备用导出方案 |
| API限流 | 中 | 申请团队Token；分时段访问 |
| AI理解偏差 | 中 | 迭代优化提示词；人工复核 |
| Token泄露 | 低 | 使用只读Token；定期轮换 |

**特殊场景替代方案**：

| 场景 | 推荐方案 | 理由 |
|------|----------|------|
| 离线环境（军工/政府） | 导出模式 | 数据安全优先 |
| 遗留项目重构 | 导出模式 | 需要版本追溯 |
| 日常开发迭代 | MCP模式 | 效率优先 |

---

## 相关章节

- [上一章：多级知识空间](./05-knowledge-spaces.md)
- [下一章：质量保障](./07-quality-assurance.md)
- [返回概要](./00-overview.md)
