# 第7章 质量保障

## 7.1 SDD 质量门禁

| 检查项 | 标准 | 检查方式 |
|--------|------|----------|
| 规格完整性 | 必填字段100%覆盖 | 自动化校验 |
| 接口一致性 | 规格与实现一致 | Contract测试 |
| 设计评审 | 评审通过 | 人工评审 |

---

## 7.2 TDD 质量门禁

| 检查项 | 标准 | 检查方式 |
|--------|------|----------|
| 测试覆盖率 | ≥80% | 自动化统计 |
| 测试用例评审 | 评审通过 | 人工评审 |
| 回归测试 | 100%通过 | CI自动运行 |

---

## 7.3 代码质量门禁

| 检查项 | 标准 | 检查方式 |
|--------|------|----------|
| 静态检查 | 0 Error | ESLint/SonarQube |
| 安全扫描 | 0 高危漏洞 | Snyk/AI SAST |
| CR审批 | 至少1人Approve | GitHub PR |

---

## 7.4 Agent 评测体系

### 7.4.1 评测集构造

| 类型 | 来源 | 用途 |
|------|------|------|
| **种子集** | 人工标注 | 初始评测基准 |
| **Badcase集** | 用户反馈 | 问题修复验证 |
| **扩展集** | LLM泛化 | 扩大评测覆盖 |
| **对抗集** | 专门设计 | 边界场景测试 |

### 7.4.2 评测指标

| 类别 | 指标 | 目标 |
|------|------|------|
| **效果指标** | 任务完成率 | >90% |
| **效果指标** | 准确率 | >85% |
| **技术指标** | 响应时间 | <30s |
| **技术指标** | Token消耗 | 合理范围 |
| **用户指标** | 满意度 | >80% |
| **用户指标** | 使用频率 | 持续增长 |

---

## 7.5 AI 辅助文档生成

文档是知识传承的关键，但传统文档维护成本高、易过时。AI 辅助文档生成将文档嵌入交付流程，实现自动化生成和持续更新。

### 7.5.1 文档生成能力

| 文档类型 | AI 能力 | 触发时机 |
|----------|---------|----------|
| **代码文档** | 基于代码生成模块摘要、函数说明 | 代码变更时 |
| **API 文档** | 生成接口描述、参数说明、示例 | API 变更时 |
| **架构图** | 生成 Mermaid 语法的系统图、流程图 | 按需或定期 |
| **Release Notes** | 基于 Commit/PR 总结关键变更 | 发布时 |
| **Runbook** | 生成运维操作手册初稿 | 新服务上线时 |

### 7.5.2 D-R-O 职责分工

| 层级 | 内容 |
|------|------|
| **委派** | 模块摘要初稿、API 输入输出描述、依赖列表、PR 变更摘要、Runbook 模板填充 |
| **审查** | 核心服务概述、公共 API/SDK 文档、操作手册步骤验证、架构页面准确性 |
| **掌控** | 文档整体策略和结构、AI 遵循的模板和标准、面向外部/安全关键/法律合规文档 |

### 7.5.3 自动化触发机制

```
┌─────────────────────────────────────────────────────────────────┐
│                    文档自动化流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  触发事件                    AI 动作                  人类动作   │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  PR 合并        ──→  更新受影响模块文档      ──→  审查变更      │
│                                                                 │
│  版本发布       ──→  生成 Release Notes     ──→  确认关键变更   │
│                                                                 │
│  新服务上线     ──→  生成 Runbook 初稿      ──→  验证操作步骤   │
│                                                                 │
│  定期任务       ──→  检测文档与代码一致性   ──→  处理不一致项   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.5.4 AGENTS.md 文档配置

在仓库的 `AGENTS.md` 中配置文档生成规则：

```markdown
## 文档配置

### 更新规则
- 代码变更时更新: docs/api/*.md, docs/modules/*.md
- Release 时生成: CHANGELOG.md, docs/release-notes/
- 新模块时创建: docs/modules/{module-name}.md

### 文档模板
- API 文档模板: .templates/api-doc.md
- 模块文档模板: .templates/module-doc.md
- Runbook 模板: .templates/runbook.md

### 质量要求
- 必须包含: 概述、使用示例、参数说明
- 格式规范: 使用 Markdown，代码块标注语言
- 图表语法: Mermaid
```

### 7.5.5 文档质量门禁

| 检查项 | 标准 | 检查方式 |
|--------|------|----------|
| 覆盖率 | 公共 API 100% 有文档 | 自动化扫描 |
| 新鲜度 | 代码变更后文档同步更新 | CI 检查 |
| 一致性 | 文档与代码行为一致 | 示例代码可运行测试 |
| 完整性 | 必填字段无遗漏 | 模板校验 |

### 7.5.6 渐进式文档生成策略

基于代码依赖关系的智能文档生成策略，采用动态规划方法从叶子模块逐步构建到仓库概览：

**生成策略**：

```
┌─────────────────────────────────────────────────────────────────┐
│                  渐进式文档生成策略                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  第一步：拓扑排序                                                │
│  ─────────────────                                              │
│  根据依赖关系确定处理顺序：被依赖的模块优先处理                    │
│                                                                 │
│  第二步：叶子模块处理                                             │
│  ─────────────────                                              │
│  为无子模块的叶子节点生成详细文档                                 │
│  • 类图、函数签名、使用示例                                       │
│                                                                 │
│  第三步：父模块聚合                                               │
│  ─────────────────                                              │
│  基于子模块文档生成父模块概述                                     │
│  • 子模块关系、数据流、接口摘要                                   │
│                                                                 │
│  第四步：仓库概览                                                 │
│  ─────────────────                                              │
│  基于所有模块文档生成端到端架构概览                               │
│  • 端到端架构图、模块职责矩阵、快速入口                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**模块复杂度判断**：

| 复杂度 | 判断条件 | 生成策略 | Agent 工具 |
|--------|----------|----------|------------|
| **简单模块** | 组件数 ≤ 3，单文件 | 一次性整体处理 | 文件读取 + LLM |
| **复杂模块** | 组件数 > 3，多文件 | 拆分组件逐个处理 | 文件读取 + 依赖注入 + LLM |
| **叶子模块** | 无子模块 | 直接生成详细文档 | 完整 Agent 工具链 |
| **父模块** | 有子模块 | 基于子模块文档聚合 | 子文档读取 + LLM |

**Agent 编排策略**：

| 模块类型 | Agent 模式 | 工具配置 |
|----------|------------|----------|
| **简单叶子** | 单次调用 | `[view_file, dependency_context]` |
| **复杂叶子** | 循环调用 | `[view_file, dependency_context, edit_file]` |
| **父模块** | 单次调用 | `[view_file]`（读取子模块文档） |

---

## 相关章节

- [上一章：统一工具链](./06-unified-toolchain.md)
- [下一章：实施路径](./08-implementation-path.md)
- [返回概要](./00-overview.md)
