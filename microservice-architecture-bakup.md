# Web3 金融平台微服务架构设计

## 一、整体架构分层

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CDN / WAF / DDoS Protection                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
┌─────────────────────────────────────────────────────────────────────────────┐
│                        AWS API Gateway / ALB                                 │
│                    (Rate Limiting, Auth, Routing)                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BFF Layer (Backend for Frontend)                     │
│              ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│              │  Web BFF     │  │  Mobile BFF  │  │  Admin BFF   │           │
│              └──────────────┘  └──────────────┘  └──────────────┘           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Service Mesh (Istio / AWS App Mesh)                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
    ┌─────────────────────────────────┼─────────────────────────────────┐
    │                                 │                                 │
    ▼                                 ▼                                 ▼
┌─────────┐                     ┌─────────┐                      ┌─────────┐
│ 用户域   │                     │ 资产域   │                      │ 业务域   │
│ Domain  │                     │ Domain  │                      │ Domain  │
└─────────┘                     └─────────┘                      └─────────┘
```

## 二、服务域划分

### 2.1 用户域 (User Domain)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              用户域 (User Domain)                           │
├────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │ user-service   │  │ auth-service   │  │ kyc-service    │               │
│  │ 用户基础信息    │  │ 认证授权       │  │ KYC/AML合规    │               │
│  └────────────────┘  └────────────────┘  └────────────────┘               │
│  ┌────────────────┐                                                        │
│  │ notification   │                                                        │
│  │ 消息通知       │                                                        │
│  └────────────────┘                                                        │
└────────────────────────────────────────────────────────────────────────────┘
```

**服务职责：**

| 服务 | 职责 | 核心能力 |
|------|------|---------|
| user-service | 用户基础信息管理 | 注册、信息维护、账户状态 |
| auth-service | 认证授权 | JWT签发、Token刷新、权限校验、2FA |
| kyc-service | KYC/AML合规 | 身份验证、合规检查、风险评估 |
| notification-service | 消息通知 | 邮件、短信、Push、站内信 |

### 2.2 资产域 (Asset Domain)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              资产域 (Asset Domain)                          │
├────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │ wallet-service │  │ custody-service│  │ chain-gateway  │               │
│  │ 托管钱包管理    │  │ 资产托管       │  │ 多链网关       │               │
│  └────────────────┘  └────────────────┘  └────────────────┘               │
│  ┌────────────────┐  ┌────────────────┐                                   │
│  │ deposit-service│  │ withdraw-svc   │                                   │
│  │ 充值服务       │  │ 提现服务       │                                   │
│  └────────────────┘  └────────────────┘                                   │
└────────────────────────────────────────────────────────────────────────────┘
```

**服务职责：**

| 服务 | 职责 | 核心能力 |
|------|------|---------|
| wallet-service | 托管钱包管理 | 地址生成、余额查询、内部转账 |
| custody-service | 资产托管 | 冷热钱包管理、密钥托管、签名服务 |
| chain-gateway | 多链网关 | 链交互抽象、交易广播、事件监听 |
| deposit-service | 充值服务 | 充值地址分配、入账确认、对账 |
| withdraw-service | 提现服务 | 提现申请、审核、链上执行 |

### 2.3 业务域 (Business Domain)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              业务域 (Business Domain)                       │
├────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │ lending-service│  │ staking-service│  │ rwa-service    │               │
│  │ 借贷核心       │  │ 质押核心       │  │ RWA资产管理    │               │
│  └────────────────┘  └────────────────┘  └────────────────┘               │
│  ┌────────────────┐  ┌────────────────┐                                   │
│  │ interest-engine│  │ settlement-svc │                                   │
│  │ 利息计算引擎   │  │ 清结算服务     │                                   │
│  └────────────────┘  └────────────────┘                                   │
└────────────────────────────────────────────────────────────────────────────┘
```

**服务职责：**

| 服务 | 职责 | 核心能力 |
|------|------|---------|
| lending-service | 借贷核心 | 借款申请、还款处理、抵押管理 |
| staking-service | 质押核心 | 质押、赎回、收益计算 |
| rwa-service | RWA资产管理 | 资产Token化、份额管理、收益分配 |
| interest-engine | 利息计算引擎 | 利率计算、复利处理、收益核算 |
| settlement-service | 清结算服务 | 交易清算、资金结算、头寸管理 |

### 2.4 运营域 (Operation Domain)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              运营域 (Operation Domain)                      │
├────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │ admin-service  │  │ audit-service  │  │ report-service │               │
│  │ 运营后台       │  │ 审计追踪       │  │ 报表服务       │               │
│  └────────────────┘  └────────────────┘  └────────────────┘               │
│  ┌────────────────┐                                                        │
│  │ risk-control   │                                                        │
│  │ 风控服务       │                                                        │
│  └────────────────┘                                                        │
└────────────────────────────────────────────────────────────────────────────┘
```

**服务职责：**

| 服务 | 职责 | 核心能力 |
|------|------|---------|
| admin-service | 运营后台 | 配置管理、人工干预、客服支持 |
| audit-service | 审计追踪 | 操作日志、变更记录、合规审计 |
| report-service | 报表服务 | 业务报表、财务报表、监管报告 |
| risk-control-service | 风控服务 | 实时风控、规则引擎、异常检测 |

### 2.5 账务域 (Accounting Domain)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              账务域 (Accounting Domain)                     │
├────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐               │
│  │ ledger-service │  │ account-service│  │ reconciliation │               │
│  │ 总账服务       │  │ 账户服务       │  │ 对账服务       │               │
│  └────────────────┘  └────────────────┘  └────────────────┘               │
└────────────────────────────────────────────────────────────────────────────┘
```

**服务职责：**

| 服务 | 职责 | 核心能力 |
|------|------|---------|
| ledger-service | 总账服务 | 复式记账、科目管理、账务处理 |
| account-service | 账户服务 | 账户开立、余额管理、冻结解冻 |
| reconciliation-service | 对账服务 | 内部对账、链上对账、差异处理 |

## 三、基础设施层

```
┌────────────────────────────────────────────────────────────────────────────┐
│                           基础设施层 (Infrastructure)                       │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        数据存储层                                     │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │ │
│  │  │ Aurora      │ │ Redis       │ │ S3          │ │ TimeStream  │    │ │
│  │  │ PostgreSQL  │ │ Cluster     │ │ Object      │ │ 时序数据    │    │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        消息与事件层                                   │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                    │ │
│  │  │ Kafka       │ │ SQS/SNS     │ │ EventBridge │                    │ │
│  │  │ 核心消息    │ │ 任务队列    │ │ 事件总线    │                    │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                    │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        可观测性层                                     │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │ │
│  │  │ CloudWatch  │ │ X-Ray       │ │ Prometheus  │ │ Grafana     │    │ │
│  │  │ 日志/指标   │ │ 链路追踪    │ │ 指标采集    │ │ 可视化     │    │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                        配置与服务治理                                 │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │ │
│  │  │ Nacos       │ │ Secrets Mgr │ │ Parameter   │ │ Consul      │    │ │
│  │  │ 配置中心    │ │ 密钥管理    │ │ Store       │ │ 服务发现    │    │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────────┘
```

### 3.1 数据存储选型

| 存储类型 | 选型 | 用途 |
|---------|------|------|
| 关系型数据库 | Aurora PostgreSQL | 核心业务数据、账务数据 |
| 缓存 | ElastiCache Redis Cluster | 会话、热点数据、分布式锁 |
| 对象存储 | S3 | 文件、日志归档、备份 |
| 时序数据库 | TimeStream | 指标数据、链上数据时序 |
| 搜索引擎 | OpenSearch | 日志分析、业务搜索 |

### 3.2 消息中间件选型

| 场景 | 选型 | 理由 |
|------|------|------|
| 核心业务消息 | MSK (Kafka) | 高吞吐、持久化、多消费者 |
| 异步任务 | SQS | 简单队列、自动伸缩 |
| 事件通知 | SNS + EventBridge | 扇出、事件路由 |

## 四、AWS 部署架构

```
                            ┌─────────────────────────────────────┐
                            │          Route 53 (DNS)             │
                            └──────────────────┬──────────────────┘
                                               │
                            ┌──────────────────▼──────────────────┐
                            │      CloudFront (CDN + WAF)         │
                            └──────────────────┬──────────────────┘
                                               │
┌──────────────────────────────────────────────┼─────────────────────────────────────────────┐
│                                    VPC (10.0.0.0/16)                                       │
│  ┌─────────────────────────────────┴─────────────────────────────────┐                    │
│  │                        Public Subnet                               │                    │
│  │  ┌────────────────┐   ┌────────────────┐   ┌────────────────┐    │                    │
│  │  │  NAT Gateway   │   │    ALB/NLB     │   │   Bastion Host │    │                    │
│  │  └────────────────┘   └───────┬────────┘   └────────────────┘    │                    │
│  └───────────────────────────────┼───────────────────────────────────┘                    │
│                                  │                                                         │
│  ┌───────────────────────────────▼───────────────────────────────────┐                    │
│  │                        Private Subnet (App)                        │                    │
│  │  ┌──────────────────────────────────────────────────────────┐    │                    │
│  │  │                   EKS Cluster                             │    │                    │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │    │                    │
│  │  │  │ Pod     │ │ Pod     │ │ Pod     │ │ Pod     │        │    │                    │
│  │  │  │ user-svc│ │wallet-sv│ │lending  │ │ ...     │        │    │                    │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘        │    │                    │
│  │  └──────────────────────────────────────────────────────────┘    │                    │
│  └───────────────────────────────────────────────────────────────────┘                    │
│                                                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐                    │
│  │                        Private Subnet (Data)                       │                    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │                    │
│  │  │ Aurora      │  │ ElastiCache │  │ MSK/Kafka   │               │                    │
│  │  │ (Multi-AZ)  │  │ Redis       │  │             │               │                    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘               │                    │
│  └───────────────────────────────────────────────────────────────────┘                    │
└───────────────────────────────────────────────────────────────────────────────────────────┘
                            │
                            │  VPC Peering / PrivateLink
                            ▼
              ┌─────────────────────────────────┐
              │   External Chain Nodes (RPC)    │
              │   (Alchemy / Infura / Self-hosted)
              └─────────────────────────────────┘
```

### 4.1 网络分层

| 子网类型 | CIDR | 用途 |
|---------|------|------|
| Public Subnet | 10.0.1.0/24, 10.0.2.0/24 | NAT Gateway, ALB, Bastion |
| Private App Subnet | 10.0.10.0/24, 10.0.11.0/24 | EKS Worker Nodes |
| Private Data Subnet | 10.0.20.0/24, 10.0.21.0/24 | Aurora, Redis, Kafka |

### 4.2 多可用区部署

```
                    Region: ap-southeast-1
    ┌──────────────────────┬──────────────────────┐
    │        AZ-a          │        AZ-b          │
    ├──────────────────────┼──────────────────────┤
    │  ┌────────────────┐  │  ┌────────────────┐  │
    │  │ EKS Workers    │  │  │ EKS Workers    │  │
    │  │ (Auto Scaling) │  │  │ (Auto Scaling) │  │
    │  └────────────────┘  │  └────────────────┘  │
    │  ┌────────────────┐  │  ┌────────────────┐  │
    │  │ Aurora Primary │◄─┼──│ Aurora Replica │  │
    │  └────────────────┘  │  └────────────────┘  │
    │  ┌────────────────┐  │  ┌────────────────┐  │
    │  │ Redis Primary  │◄─┼──│ Redis Replica  │  │
    │  └────────────────┘  │  └────────────────┘  │
    └──────────────────────┴──────────────────────┘
```

## 五、可插拔架构设计

### 5.1 服务编排矩阵

根据产品需求，可灵活组装服务：

| 产品形态 | 必选服务 | 可选服务 |
|---------|---------|---------|
| 托管钱包产品 | user, auth, wallet, custody, chain-gateway, deposit, withdraw, ledger, account | kyc, notification, admin |
| 借贷产品 | user, auth, wallet, lending, interest-engine, settlement, ledger, account, risk-control | kyc, notification, admin |
| Staking产品 | user, auth, wallet, staking, interest-engine, ledger, account | notification, admin |
| RWA产品 | user, auth, kyc, wallet, rwa, settlement, ledger, account, audit | notification, admin, report |
| 全功能平台 | 所有服务 | - |

### 5.2 服务依赖关系

```
                          ┌─────────────┐
                          │ auth-service│
                          └──────┬──────┘
                                 │
              ┌──────────────────┼──────────────────┐
              │                  │                  │
              ▼                  ▼                  ▼
       ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
       │user-service │   │wallet-service│   │ 业务服务    │
       └─────────────┘   └──────┬──────┘   └──────┬──────┘
                                │                  │
                                ▼                  ▼
                         ┌─────────────┐   ┌─────────────┐
                         │ledger-service│   │account-svc  │
                         └─────────────┘   └─────────────┘
```

## 六、链上交互架构

```
┌────────────────────────────────────────────────────────────────────────────┐
│                           Chain Gateway 架构                                │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                     Chain Abstraction Layer                          │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │ │
│  │  │ Ethereum    │ │ BSC         │ │ Polygon     │ │ Arbitrum    │    │ │
│  │  │ Adapter     │ │ Adapter     │ │ Adapter     │ │ Adapter     │    │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                    │                                       │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                     Core Functions                                    │ │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐              │ │
│  │  │ Transaction   │ │ Event         │ │ Balance       │              │ │
│  │  │ Builder       │ │ Listener      │ │ Query         │              │ │
│  │  └───────────────┘ └───────────────┘ └───────────────┘              │ │
│  │  ┌───────────────┐ ┌───────────────┐                                │ │
│  │  │ Gas           │ │ Nonce         │                                │ │
│  │  │ Estimator     │ │ Manager       │                                │ │
│  │  └───────────────┘ └───────────────┘                                │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                    │                                       │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                     RPC Provider Layer                                │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                    │ │
│  │  │ Primary     │ │ Fallback    │ │ Self-hosted │                    │ │
│  │  │ (Alchemy)   │ │ (Infura)    │ │ (Archive)   │                    │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                    │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────────┘
```

## 七、安全架构

### 7.1 安全分层

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              安全架构分层                                   │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  网络安全层                                                                │
│  ├── WAF (AWS WAF) - SQL注入、XSS防护                                      │
│  ├── DDoS防护 (AWS Shield)                                                 │
│  └── 安全组 + NACL                                                         │
│                                                                            │
│  应用安全层                                                                │
│  ├── API网关认证 (JWT + API Key)                                           │
│  ├── 服务间mTLS (Istio)                                                    │
│  └── 请求签名校验                                                          │
│                                                                            │
│  数据安全层                                                                │
│  ├── 传输加密 (TLS 1.3)                                                    │
│  ├── 存储加密 (AES-256)                                                    │
│  └── 密钥管理 (AWS KMS + Secrets Manager)                                  │
│                                                                            │
│  密钥安全层                                                                │
│  ├── HSM硬件安全模块                                                       │
│  ├── 多签机制                                                              │
│  └── 冷热钱包分离                                                          │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 认证授权流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Client  │────▶│ API GW   │────▶│ Auth Svc │────▶│ Service  │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
     │                │                │                │
     │  1. Request    │                │                │
     │  + API Key     │                │                │
     │───────────────▶│                │                │
     │                │  2. Validate   │                │
     │                │  API Key       │                │
     │                │───────────────▶│                │
     │                │                │  3. Issue JWT  │
     │                │◀───────────────│                │
     │                │                │                │
     │                │  4. Forward    │                │
     │                │  + JWT         │                │
     │                │───────────────────────────────▶│
     │                │                │                │
     │  5. Response   │                │                │
     │◀──────────────────────────────────────────────────│
```

## 八、高可用设计

### 8.1 容灾策略

| 故障场景 | 恢复策略 | RTO | RPO |
|---------|---------|-----|-----|
| 单实例故障 | K8s自动重启/调度 | < 1分钟 | 0 |
| 单AZ故障 | 多AZ自动切换 | < 5分钟 | 0 |
| 数据库故障 | Aurora自动故障转移 | < 2分钟 | 0 |
| 区域故障 | 跨Region DR (未来) | < 30分钟 | < 5分钟 |

### 8.2 限流降级

```yaml
限流策略:
  用户级: 100 req/s per user
  IP级: 1000 req/s per IP
  接口级: 根据接口配置

熔断策略:
  错误率阈值: 50%
  慢调用阈值: 5s
  熔断时长: 30s

降级策略:
  - 非核心功能降级
  - 返回缓存数据
  - 返回默认响应
```
